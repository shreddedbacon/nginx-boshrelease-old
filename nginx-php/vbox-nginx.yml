---
name: nginx

releases:
- name: nginx
  version: latest

instance_groups:
- name: nginx
  instances: 1
  resource_pool: default
  vm_type: default
  azs: [z1]
  persistent_disk_type: default
  networks:
  - name: default
    static:
      - 10.244.0.50
  jobs:
  - name: nginx
    release: nginx
    properties:
      nginx_conf: |
        worker_processes  1;
        error_log /var/vcap/sys/log/nginx/error.log   info;
        events {
          worker_connections  1024;
        }
        http {
          include /var/vcap/packages/nginx/conf/mime.types;
          default_type  application/octet-stream;
          sendfile        on;
          keepalive_timeout  65;
          server_names_hash_bucket_size 64;
          # redirect HTTP to HTTPS
          server {
            server_name ; # invalid value which will never trigger on a real hostname.
            listen 80;
            # FIXME: replace all occurrences of 'www.nono.io' with your server's FQDN
            access_log /var/vcap/sys/log/nginx/www.nono.io-access.log;
            error_log /var/vcap/sys/log/nginx/www.nono.io-error.log;
            root /var/vcap/store/nginx/www/document_root;
            #index index.php index.shtml index.html index.htm;
            index index.html index.htm;

            #location / {
            #    try_files $uri $uri/ =404;
            #}

            #location ~ \.php$ {
            #    try_files $uri =404;
            #    fastcgi_split_path_info ^(.+\.php)(/.+)$;
            #    fastcgi_pass 127.0.0.1:9000;
            #    fastcgi_index index.php;
            #    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            #    include fastcgi_params;
            #}

          }
        }
      pre_start: |
        #!/bin/bash -ex
        NGINX_DIR=/var/vcap/store/nginx/www/document_root
        if [ ! -d $NGINX_DIR ]; then
          mkdir -p $NGINX_DIR
          cd $NGINX_DIR
          curl -L https://github.com/cunnie/sslip.io/archive/v1.tar.gz |
            tar xzf -
          mv sslip.io-1 www
          chown -R vcap:vcap $NGINX_DIR
          #echo "<?php phpinfo();?>" > $NGINX_DIR/www/document_root/info.php
        fi


update:
  canaries: 1
  max_in_flight: 1
  serial: false
  canary_watch_time: 1000-60000
  update_watch_time: 1000-60000
